apiVersion: keda.k8s.io/v1alpha1
kind: ScaledObject
metadata:
  name: {{ template "hmcts.releasename.v1" . }}
spec:
  scaleType: {{ .Values.scaleType }}
  pollingInterval: {{ .Values.pollingInterval }}
  cooldownPeriod:  {{ .Values.cooldownPeriod }}
  minReplicaCount: {{ .Values.minReplicaCount }}
  maxReplicaCount: {{ .Values.maxReplicaCount }}
  jobTargetRef:
    parallelism: {{ .Values.job.parallelism }}
    completions: {{ .Values.job.completions }}
    activeDeadlineSeconds: {{ .Values.job.activeDeadlineSeconds }}
    backoffLimit: {{ .Values.job.backoffLimit }}
{{ include "hmcts.podtemplate.v1.tpl" . | indent 4 }}
  triggers:
    - type: {{ .Values.trigger.type}}
      {{- if eq .Values.trigger.type "azure-servicebus" }}
      metadata:
        {{- if .Values.trigger.servicebus.queueName }}
        queueName: {{ .Values.trigger.servicebus.queueName }}
        {{- end }}
        {{- if .Values.trigger.servicebus.topicName }}
        topicName: {{ .Values.trigger.servicebus.topicName }}
        subscriptionName: {{ .Values.trigger.servicebus.subscriptionName }}
        {{- end }}
        connection: {{ .Values.trigger.servicebus.connection }}
        queueLength: {{ .Values.trigger.servicebus.queueLength | quote}}
      {{- else if eq .Values.trigger.type "azure-blob" }}
      metadata:
        blobContainerName: {{ .Values.trigger.blob.containerName }}
        {{- if .Values.trigger.blob.blobCount }}
        blobCount: {{ .Values.trigger.blob.blobCount }}
        {{- end }}
        connection: {{ .Values.trigger.blob.connection }}
        {{- if .Values.trigger.blob.blobPrefix }}
        blobPrefix: {{ .Values.trigger.blob.blobPrefix }}
        {{- end }}
        {{- if .Values.trigger.blob.blobDelimiter }}
        blobDelimiter: {{ .Values.trigger.blob.blobDelimiter }}
        {{- end }}
      {{- end }}